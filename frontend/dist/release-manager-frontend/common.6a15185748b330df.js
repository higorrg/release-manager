"use strict";(self.webpackChunkrelease_manager_frontend=self.webpackChunkrelease_manager_frontend||[]).push([[76],{7225:(f,d,s)=>{s.d(d,{p:()=>k});var n=s(4438),u=s(1626),p=s(2825);let k=(()=>{class l{http=(0,n.WQX)(u.Qq);authService=(0,n.WQX)(p.u);apiUrl="http://localhost:8081/api/v1/releases";getHeaders(){const r=this.authService.getAccessToken();return new u.Lr({Authorization:`Bearer ${r}`,"Content-Type":"application/json"})}createReleaseFromPipeline(r){return this.http.post(`${this.apiUrl}/pipeline`,r,{headers:this.getHeaders()})}updateReleaseStatus(r,o,i){return this.http.put(`${this.apiUrl}/${r}/status`,{status:o,comments:i},{headers:this.getHeaders()})}updateReleaseNotes(r,o){return this.http.put(`${this.apiUrl}/${r}/release-notes`,{releaseNotes:o},{headers:this.getHeaders()})}updatePrerequisites(r,o){return this.http.put(`${this.apiUrl}/${r}/prerequisites`,{prerequisites:o},{headers:this.getHeaders()})}getRelease(r){return this.http.get(`${this.apiUrl}/${r}`,{headers:this.getHeaders()})}getReleaseById(r){return this.getRelease(r)}getReleaseStatusHistory(r){return this.http.get(`${this.apiUrl}/${r}/history`,{headers:this.getHeaders()})}getAvailableStatuses(){return["MR Aprovado","Falha no Build para Teste","Para Teste de Sistema","Reprovada no teste","Aprovada no teste","Falha no Build para Produ\xe7\xe3o","Para Teste Regressivo","Falha na instala\xe7\xe3o da Est\xe1vel","Interno","Revogada","Reprovada no teste regressivo","Aprovada no teste regressivo","Controlada","Dispon\xedvel"]}addControlledClient(r,o,i){return this.http.post(`${this.apiUrl}/${r}/controlled-clients`,{clientCode:o,environment:i},{headers:this.getHeaders()})}removeControlledClient(r,o){return this.http.delete(`${this.apiUrl}/${r}/controlled-clients/${o}`,{headers:this.getHeaders()})}static \u0275fac=function(o){return new(o||l)};static \u0275prov=n.jDH({token:l,factory:l.\u0275fac,providedIn:"root"})}return l})()},2825:(f,d,s)=>{s.d(d,{u:()=>y});var n=s(4438),u=s(1626),p=s(2183),k=s(4412),l=s(8810),m=s(7673),r=s(8141),o=s(6354),i=s(9437);let y=(()=>{class h{http=(0,n.WQX)(u.Qq);router=(0,n.WQX)(p.Ix);currentUserSubject=new k.t(null);currentUser$=this.currentUserSubject.asObservable();accessToken=(0,n.vPA)(null);refreshToken=(0,n.vPA)(null);tokenExpiry=(0,n.vPA)(null);isAuthenticated=(0,n.EWP)(()=>{const e=this.accessToken(),t=this.tokenExpiry();return!(!e||!t)&&Date.now()<t});user=(0,n.EWP)(()=>this.currentUserSubject.value);keycloakConfig={url:"http://localhost:8080",realm:"release-manager",clientId:"release-manager-app",redirectUri:"http://localhost:4200/callback"};constructor(){this.loadStoredTokens(),this.checkTokenExpiry()}login(){const e=new URLSearchParams({client_id:this.keycloakConfig.clientId,redirect_uri:this.keycloakConfig.redirectUri,response_type:"code",scope:"openid profile email",state:this.generateState()}),t=`${this.keycloakConfig.url}/realms/${this.keycloakConfig.realm}/protocol/openid-connect/auth?${e}`;sessionStorage.setItem("redirectUrl",this.router.url),window.location.href=t}handleCallback(e,t){return t!==sessionStorage.getItem("oauth_state")?(0,l.$)(()=>new Error("Invalid state parameter")):this.exchangeCodeForTokens(e).pipe((0,r.M)(g=>{this.storeTokens(g),this.loadUserInfo()}),(0,o.T)(()=>!0),(0,i.W)(g=>(console.error("Error during token exchange:",g),(0,m.of)(!1))))}exchangeCodeForTokens(e){const t=new URLSearchParams({grant_type:"authorization_code",code:e,client_id:this.keycloakConfig.clientId,redirect_uri:this.keycloakConfig.redirectUri});return this.http.post(`${this.keycloakConfig.url}/realms/${this.keycloakConfig.realm}/protocol/openid-connect/token`,t.toString(),{headers:{"Content-Type":"application/x-www-form-urlencoded"}})}refreshAccessToken(){const e=this.refreshToken();if(!e)return(0,l.$)(()=>new Error("No refresh token available"));const t=new URLSearchParams({grant_type:"refresh_token",refresh_token:e,client_id:this.keycloakConfig.clientId});return this.http.post(`${this.keycloakConfig.url}/realms/${this.keycloakConfig.realm}/protocol/openid-connect/token`,t.toString(),{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).pipe((0,r.M)(a=>this.storeTokens(a)),(0,i.W)(a=>(console.error("Error refreshing token:",a),this.logout(),(0,l.$)(()=>a))))}loadUserInfo(){const e=this.accessToken();e&&this.http.get(`${this.keycloakConfig.url}/realms/${this.keycloakConfig.realm}/protocol/openid-connect/userinfo`,{headers:{Authorization:`Bearer ${e}`}}).subscribe({next:t=>{this.currentUserSubject.next({id:t.sub,username:t.preferred_username||t.sub,email:t.email,name:t.name||t.preferred_username,roles:t.realm_access?.roles||[]})},error:t=>{console.error("Error loading user info:",t)}})}logout(){const e=this.refreshToken();if(this.clearTokens(),this.currentUserSubject.next(null),e){const t=new URLSearchParams({client_id:this.keycloakConfig.clientId,refresh_token:e,post_logout_redirect_uri:window.location.origin});window.location.href=`${this.keycloakConfig.url}/realms/${this.keycloakConfig.realm}/protocol/openid-connect/logout?${t}`}else this.router.navigate(["/login"])}getAccessToken(){const e=this.tokenExpiry();return e&&Date.now()>e-6e4&&this.refreshAccessToken().subscribe(),this.accessToken()}hasRole(e){const t=this.user();return!!t&&t.roles.includes(e)}storeTokens(e){this.accessToken.set(e.access_token),this.refreshToken.set(e.refresh_token);const t=Date.now()+1e3*e.expires_in;this.tokenExpiry.set(t),localStorage.setItem("access_token",e.access_token),localStorage.setItem("refresh_token",e.refresh_token),localStorage.setItem("token_expiry",t.toString())}loadStoredTokens(){const e=localStorage.getItem("access_token"),t=localStorage.getItem("refresh_token"),a=localStorage.getItem("token_expiry");e&&t&&a&&(this.accessToken.set(e),this.refreshToken.set(t),this.tokenExpiry.set(parseInt(a,10)),this.isAuthenticated()?this.loadUserInfo():this.refreshAccessToken().subscribe())}clearTokens(){this.accessToken.set(null),this.refreshToken.set(null),this.tokenExpiry.set(null),localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token"),localStorage.removeItem("token_expiry"),sessionStorage.removeItem("oauth_state"),sessionStorage.removeItem("redirectUrl")}generateState(){const e=Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15);return sessionStorage.setItem("oauth_state",e),e}checkTokenExpiry(){setInterval(()=>{const e=this.tokenExpiry();e&&Date.now()>e-12e4&&this.refreshAccessToken().subscribe()},6e4)}static \u0275fac=function(t){return new(t||h)};static \u0275prov=n.jDH({token:h,factory:h.\u0275fac,providedIn:"root"})}return h})()}}]);